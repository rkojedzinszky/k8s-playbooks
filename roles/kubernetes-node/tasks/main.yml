---
- name: Pre-check
  run_once: yes
  delegate_to: localhost
  import_tasks: precheck.yml

- apt: name=curl,tcpdump,nfs-common

- name: Install container runtime
  include_tasks: "{{ container_runtime }}.yml"

- name: Generate kubelet config for cgroup driver
  copy:
    content: |
      KUBELET_EXTRA_ARGS=--cgroup-driver={{ container_runtime_cgroup_driver }}
    dest: /etc/default/kubelet

- name: disable any swap
  lineinfile: dest=/etc/fstab regexp=swap state=absent

- apt_key: url=https://packages.cloud.google.com/apt/doc/apt-key.gpg
- copy: src=kubernetes.list dest=/etc/apt/sources.list.d/
  notify: update apt cache
- meta: flush_handlers
- apt:
    name: "kubelet={{ kubernetes_version }}-00,kubeadm={{ kubernetes_version }}-00,kubectl={{ kubernetes_version }}-00"
- shell: apt-mark hold kubelet kubeadm kubectl
- systemd: daemon_reload=yes name=kubelet state=restarted

- name: deploy kubernetes sysctls
  template:
    src: kubernetes-node.conf.j2
    dest: /etc/sysctl.d/kubernetes-node.conf
  notify: apply kubernetes sysctls
  tags:
  - sysctl
