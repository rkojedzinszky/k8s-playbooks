---
- name: Import variables
  include_vars: roles/kubernetes-node/vars/main.yml

- name: Check existing kubeadm versions
  command: kubeadm version -o short
  register: kubeadm_version

- fail:
    msg: "existing kubeadm version must be {{ kubernetes_version_prev }} or {{ kubernetes_version }}"
  when: kubeadm_version.stdout not in ['v' + kubernetes_version_prev, 'v' + kubernetes_version]

- name: Upgrade kubeadm
  when: kubeadm_version.stdout == ('v' + kubernetes_version_prev)
  block:
  - name: Unhold kubeadm
    command: apt-mark unhold kubeadm

  - name: Upgrade kubeadm
    apt:
      name: kubeadm={{ kubernetes_version }}-00
      update_cache: yes

  - name: Hold kubeadm
    command: apt-mark hold kubeadm
