---
- hosts: cluster
  remote_user: root
  gather_facts: no
  tasks:
  - name: install minimal ansible dependencies
    raw: apt install -y python

  - name: create {{ admin_user }}
    user: name={{ admin_user }} shell={{ admin_shell }}

  - name: get {{ admin_user }} home directory path
    shell: awk '-F:' '$1 == "{{ admin_user }}" {print $6}' /etc/passwd
    register: admin_user_homedir

  - name: create {{ admin_user }} .ssh directory
    file: path={{ admin_user_homedir.stdout }}/.ssh state=directory

  - name: create {{ admin_user }} authorized_keys file
    copy: dest={{ admin_user_homedir.stdout }}/.ssh/authorized_keys content={{ admin_user_ssh_key }}

  - name: set ownership of {{ admin_user }} .ssh directory
    file: path={{ admin_user_homedir.stdout }} state=directory owner={{ admin_user }} group={{ admin_user }} recurse=yes

  - name: install sudo
    apt: name=sudo

  - name: set sudo passwd-less for {{ admin_user }}
    copy:
      dest: /etc/sudoers.d/admin
      content: "{{ admin_user }} ALL=(ALL:ALL) NOPASSWD: ALL"
      owner: root
      group: root
      mode: "0400"
